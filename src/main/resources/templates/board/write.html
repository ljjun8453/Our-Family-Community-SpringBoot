<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout2}">

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/write.css}"/>
    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
</th:block>

<th:block layout:fragment="script">
    <!-- Toast UI ì—ë””í„° CSS, JS, í•œêµ­ì–´ ì–¸ì–´íŒ© -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/i18n/ko-kr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script th:src="@{/js/write.js}" defer></script>
    <script th:inline="javascript">
        $(function(){
            if ($('.custom-file-input').length > 0) {
                $('.custom-file-input').on("change", function() {
                    var fileName = $(this).val().split("\\").pop();
                    var ext = (fileName.split('.').pop() || '').toLowerCase();
                    var ok = ['jpg','jpeg','gif','png','bmp','mp4','wav','wmv','mp3',
                        'webm','ogg','m4v','mov','m4a','aac','flac','svg','webp'].includes(ext);
                    if (!ok) { alert("í—ˆìš©ë˜ì§€ ì•Šì€ í™•ì¥ìì…ë‹ˆë‹¤."); return; }
                    var $label = $(this).siblings('.custom-file-label');
                    if ($label.length) $label.text(fileName);
                });
            }
        });
    </script>
</th:block>

<div layout:fragment="content">
    <main>
        <!-- ê¸€ì“°ê¸° -->
        <section class="board-section">
            <div class="section-header">
                <h2 th:switch="${boardType}">
                    <span th:case="${T(com.community.constant.BoardType).NOTICE}">ğŸ“¢ ê³µì§€ì‚¬í•­ ê¸€ì“°ê¸°</span>
                    <span th:case="${T(com.community.constant.BoardType).FREE}">ğŸ’¬ ììœ ê²Œì‹œíŒ ê¸€ì“°ê¸°</span>
                    <span th:case="${T(com.community.constant.BoardType).ALBUM}">ğŸ“¸ ê°€ì¡± ì•¨ë²” ê¸€ì“°ê¸°</span>
                    <span th:case="${T(com.community.constant.BoardType).EVENT}">ğŸ‰ ì´ë²¤íŠ¸ ì†Œì‹ ê¸€ì“°ê¸°</span>
                    <span th:case="*">ğŸ“Œ ê²Œì‹œíŒ ê¸€ì“°ê¸°</span>
                </h2>
            </div>
            <form method="POST" enctype="multipart/form-data" class="write-form" th:object="${postFormDto}" onsubmit="return __write_onSubmit();">
                <input type="hidden" th:field="*{id}"/>

                <p th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="fieldError">Incorrect data</p>
                <input type="text" maxlength="30" th:field="*{title}" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                       style="width:100%; padding:10px; margin-bottom:10px;">

                <!-- Toast UI ì—ë””í„° ì‚½ì… -->
                <div id="editor"></div>
                <!-- ì‹¤ì œ ì „ì†¡ë  ìˆ¨ì€ input -->
                <input type="hidden" id="contentHidden" th:field="*{content}">
                <p th:if="${#fields.hasErrors('content')}" class="fieldError" th:errors="*{content}"></p>

                <!-- ê¸°ì¡´ ì…ë ¥ UI -->
<!--                <p th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="fieldError">Incorrect data</p>-->
<!--                <textarea th:field="*{content}" aria-label="With textarea" style="width:100%; padding:10px;" rows="20"-->
<!--                          placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>-->

                <!-- íŒŒì¼ ì²¨ë¶€ -->
                <div th:if="${#lists.isEmpty(postFormDto.postMediaDtoList)}">
<!--                    <div th:each="num: ${#numbers.sequence(1,postFormDto.postMediaDtoList.size())}">-->
                    <div class="margin-top">
                        <label class="custom-file-label">ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ê°œ ì„ íƒ ê°€ëŠ¥):</label><br>
                        <input type="file" class="custom-file-input" name="postMediaFile" multiple="multiple" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,.mp4,.webm,.ogg,.m4v,.mov,.mp3,.wav,.m4a,.aac,.flac">
<!--                        <label th:text="ì²¨ë¶€íŒŒì¼ + ${num}"></label>-->
<!--                        <div id="file-warning" class="alert alert-warning" style="display: none;"></div>-->
<!--                        <div id="file-list" class="margin-top"></div>-->
                    </div>
<!--                    </div>-->
                </div>

                <div th:if="${!#lists.isEmpty(postFormDto.postMediaDtoList)}">
                    <div th:each="postMediaDto, status: ${postFormDto.postMediaDtoList}">
                        <div class="margin-top">
                            <label class="custom-file-label">ì²¨ë¶€íŒŒì¼ ë³€ê²½:</label><br>
                            <input type="file" class="custom-file-input" name="postMediaFile" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,.mp4,.webm,.ogg,.m4v,.mov,.mp3,.wav,.m4a,.aac,.flac">
                            <input type="hidden" name="postMediaIds" th:value="${postMediaDto.id}">
                            <label th:text="${not #strings.isEmpty(postMediaDto.originalName)} ? ${postMediaDto.originalName} : 'ì²¨ë¶€íŒŒì¼' + ${status.index+1}"></label>
<!--                            <div id="file-warning" class="alert alert-warning" style="display: none;"></div>-->
<!--                            <div id="file-list" class="margin-top"></div>-->
                        </div>
                    </div>
                    <div class="margin-top">
                        <label class="custom-file-label">ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (ì—¬ëŸ¬ê°œ ì„ íƒ ê°€ëŠ¥):</label><br>
                        <input type="file" class="custom-file-input" name="postMediaAdd" multiple="multiple" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,.mp4,.webm,.ogg,.m4v,.mov,.mp3,.wav,.m4a,.aac,.flac">
                    </div>
                </div>

                <div class="text-align-right write-container">
                    <a th:href="@{/board/{boardType}(boardType=${boardType})}" class="btn btn-list">ëª©ë¡ìœ¼ë¡œ ğŸ“„</a>
                    <!-- ìƒˆ ê¸€: ì‘ì„± -->
                    <div th:if="${postFormDto.id == null}">
                        <button th:formaction="@{/board/{boardType}/new(boardType=${boardType})}" type="submit"
                                class="btn btn-write">ì‘ì„± ì™„ë£Œ âœ…
                        </button>
                    </div>

                    <!-- ìˆ˜ì • í™”ë©´: ìˆ˜ì • -->
                    <div th:if="${postFormDto.id != null}">
                        <button type="submit"
                                th:if="${postFormDto.id != null}"
                                th:formaction="@{/board/{boardType}/{postId}(boardType=${boardType}, postId=${postFormDto.id})}"
                                class="btn btn-write">
                            ìˆ˜ì • ì™„ë£Œ âœï¸
                        </button>
                    </div>
                </div>

                <!-- CSRF ë³´í˜¸ -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            </form>
        </section>
    </main>

    <!-- ë¡œë”© ëª¨ë‹¬ì°½ -->
    <div id="uploadModal" class="modal"
         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:10px; width:300px; text-align:center;">
            <h3 id="uploadStatus">íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</h3>
            <div style="margin-top:15px; background:#eee; border-radius:5px; overflow:hidden; height:20px;">
                <div id="uploadProgress" style="width:0%; height:100%; background:#4caf50;"></div>
            </div>
        </div>
    </div>
</div>
</html>
