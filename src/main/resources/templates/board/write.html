<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout2}">

<th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/write.css}"/>
    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
</th:block>

<th:block layout:fragment="script">
    <!-- Toast UI 에디터 CSS, JS, 한국어 언어팩 -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/i18n/ko-kr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script th:src="@{/js/write.js}" defer></script>
    <script th:inline="javascript">
        $(function(){
            if ($('.custom-file-input').length > 0) {
                $('.custom-file-input').on("change", function() {
                    var fileName = $(this).val().split("\\").pop();
                    var ext = (fileName.split('.').pop() || '').toLowerCase();
                    var ok = ['jpg','jpeg','gif','png','bmp','mp4','wav','wmv','mp3',
                        'webm','ogg','m4v','mov','m4a','aac','flac','svg','webp'].includes(ext);
                    if (!ok) { alert("허용되지 않은 확장자입니다."); return; }
                    var $label = $(this).siblings('.custom-file-label');
                    if ($label.length) $label.text(fileName);
                });
            }
        });
    </script>
</th:block>

<div layout:fragment="content">
    <main>
        <!-- 글쓰기 -->
        <section class="board-section">
            <div class="section-header">
                <h2 th:switch="${boardType}">
                    <span th:case="${T(com.community.constant.BoardType).NOTICE}">📢 공지사항 글쓰기</span>
                    <span th:case="${T(com.community.constant.BoardType).FREE}">💬 자유게시판 글쓰기</span>
                    <span th:case="${T(com.community.constant.BoardType).ALBUM}">📸 가족 앨범 글쓰기</span>
                    <span th:case="${T(com.community.constant.BoardType).EVENT}">🎉 이벤트 소식 글쓰기</span>
                    <span th:case="*">📌 게시판 글쓰기</span>
                </h2>
            </div>
            <form method="POST" enctype="multipart/form-data" class="write-form" th:object="${postFormDto}" onsubmit="return __write_onSubmit();">
                <input type="hidden" th:field="*{id}"/>

                <p th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="fieldError">Incorrect data</p>
                <input type="text" maxlength="30" th:field="*{title}" placeholder="제목을 입력하세요"
                       style="width:100%; padding:10px; margin-bottom:10px;">

                <!-- Toast UI 에디터 삽입 -->
                <div id="editor"></div>
                <!-- 실제 전송될 숨은 input -->
                <input type="hidden" id="contentHidden" th:field="*{content}">
                <p th:if="${#fields.hasErrors('content')}" class="fieldError" th:errors="*{content}"></p>

                <!-- 기존 입력 UI -->
<!--                <p th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="fieldError">Incorrect data</p>-->
<!--                <textarea th:field="*{content}" aria-label="With textarea" style="width:100%; padding:10px;" rows="20"-->
<!--                          placeholder="내용을 입력하세요"></textarea>-->

                <!-- 파일 첨부 -->
                <div th:if="${#lists.isEmpty(postFormDto.postMediaDtoList)}">
<!--                    <div th:each="num: ${#numbers.sequence(1,postFormDto.postMediaDtoList.size())}">-->
                    <div class="margin-top">
                        <label class="custom-file-label">첨부파일 업로드 (여러개 선택 가능):</label><br>
                        <input type="file" class="custom-file-input" name="postMediaFile" multiple="multiple" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,.mp4,.webm,.ogg,.m4v,.mov,.mp3,.wav,.m4a,.aac,.flac">
<!--                        <label th:text="첨부파일 + ${num}"></label>-->
<!--                        <div id="file-warning" class="alert alert-warning" style="display: none;"></div>-->
<!--                        <div id="file-list" class="margin-top"></div>-->
                    </div>
<!--                    </div>-->
                </div>

                <div th:if="${!#lists.isEmpty(postFormDto.postMediaDtoList)}">
                    <div th:each="postMediaDto, status: ${postFormDto.postMediaDtoList}">
                        <div class="margin-top">
                            <label class="custom-file-label">첨부파일 변경:</label><br>
                            <input type="file" class="custom-file-input" name="postMediaFile" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,.mp4,.webm,.ogg,.m4v,.mov,.mp3,.wav,.m4a,.aac,.flac">
                            <input type="hidden" name="postMediaIds" th:value="${postMediaDto.id}">
                            <label th:text="${not #strings.isEmpty(postMediaDto.originalName)} ? ${postMediaDto.originalName} : '첨부파일' + ${status.index+1}"></label>
<!--                            <div id="file-warning" class="alert alert-warning" style="display: none;"></div>-->
<!--                            <div id="file-list" class="margin-top"></div>-->
                        </div>
                    </div>
                    <div class="margin-top">
                        <label class="custom-file-label">첨부파일 업로드 (여러개 선택 가능):</label><br>
                        <input type="file" class="custom-file-input" name="postMediaAdd" multiple="multiple" accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.svg,.mp4,.webm,.ogg,.m4v,.mov,.mp3,.wav,.m4a,.aac,.flac">
                    </div>
                </div>

                <div class="text-align-right write-container">
                    <a th:href="@{/board/{boardType}(boardType=${boardType})}" class="btn btn-list">목록으로 📄</a>
                    <!-- 새 글: 작성 -->
                    <div th:if="${postFormDto.id == null}">
                        <button th:formaction="@{/board/{boardType}/new(boardType=${boardType})}" type="submit"
                                class="btn btn-write">작성 완료 ✅
                        </button>
                    </div>

                    <!-- 수정 화면: 수정 -->
                    <div th:if="${postFormDto.id != null}">
                        <button type="submit"
                                th:if="${postFormDto.id != null}"
                                th:formaction="@{/board/{boardType}/{postId}(boardType=${boardType}, postId=${postFormDto.id})}"
                                class="btn btn-write">
                            수정 완료 ✏️
                        </button>
                    </div>
                </div>

                <!-- CSRF 보호 -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            </form>
        </section>
    </main>

    <!-- 로딩 모달창 -->
    <div id="uploadModal" class="modal"
         style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:20px 30px; border-radius:10px; width:300px; text-align:center;">
            <h3 id="uploadStatus">파일 업로드 중...</h3>
            <div style="margin-top:15px; background:#eee; border-radius:5px; overflow:hidden; height:20px;">
                <div id="uploadProgress" style="width:0%; height:100%; background:#4caf50;"></div>
            </div>
        </div>
    </div>
</div>
</html>
